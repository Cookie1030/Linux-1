<?xml version="1.0" encoding="UTF-8"?>
<chapter id="index"><?dbhtml dir="zabbix" ?>
	<title>Zabbix</title>
	<section id="install">
		<title>Installing and Configuring Zabbix</title>
		<section>
			<title>Ubuntu</title>
			<screen>
neo@monitor:~$ apt-cache search zabbix
zabbix-agent - network monitoring solution - agent
zabbix-frontend-php - network monitoring solution - PHP front-end
zabbix-proxy-mysql - network monitoring solution - proxy (using MySQL)
zabbix-proxy-pgsql - network monitoring solution - proxy (using PostgreSQL)
zabbix-server-mysql - network monitoring solution - server (using MySQL)
zabbix-server-pgsql - network monitoring solution - server (using PostgreSQL)
			</screen>
			<screen>
GRANT ALL PRIVILEGES ON zabbix.* TO 'zabbix'@'localhost' IDENTIFIED BY 'chen' WITH GRANT OPTION;
FLUSH PRIVILEGES;
			</screen>
			<screen>
sudo apt-get install zabbix-server-mysql zabbix-frontend-php
			</screen>
			<para>如果上述过程中遇到一些问题，可以手工安装数据库</para>
			<screen>
			<![CDATA[
$ sudo mysql -uroot -p -e"create database zabbix;"
$ sudo mysql -uroot -p -e"grant all privileges on zabbix.* to zabbix@localhost identified by 'enter-password-here';"
$ mysql -uzabbix -p zabbix < /usr/share/zabbix-server/mysql.sql
$ mysql -uzabbix -p zabbix < /usr/share/zabbix-server/data.sql
$ sudo dpkg-reconfigure zabbix-server-mysql
			]]>
			</screen>

			<screen>
			<![CDATA[
cat >> /etc/services <<EOF

zabbix-agent    10050/tcp                       #Zabbix Agent
zabbix-agent    10050/udp                       #Zabbix Agent
zabbix-trapper  10051/tcp                       #Zabbix Trapper
zabbix-trapper  10051/udp                       #Zabbix Trapper
EOF
			]]>
			</screen>
		</section>
		<section>
			<title>CentOS Zabbix 2.4</title>
			<screen>
			<![CDATA[
yum localinstall -y http://repo.zabbix.com/zabbix/2.4/rhel/7/x86_64/zabbix-release-2.4-1.el7.noarch.rpm

yum install -y zabbix-server-mysql zabbix-web-mysql

cd /usr/share/doc/zabbix-server-mysql-2.4.0/create/

mysql -uzabbix -p zabbix < schema.sql
mysql -uzabbix -p zabbix < images.sql
mysql -uzabbix -p zabbix < data.sql

cp /etc/zabbix/zabbix_server.conf{,.original}
vim /etc/zabbix/zabbix_server.conf <<EOF > /dev/null 2>&1
:%s/# DBPassword=/DBPassword=your_password/
:wq
EOF

systemctl start zabbix-server
systemctl restart httpd
			]]>
			</screen>
		</section>
		<section>
			<title>Zabbix 3.x CentOS 7</title>
			<para>安装脚本</para>
			<screen>
			<![CDATA[
#!/bin/bash
##################################################
# Author: Neo <netkiller@msn.com>
# Website http://netkiller.github.io
##################################################
yum localinstall -y http://repo.zabbix.com/zabbix/3.2/rhel/7/x86_64/zabbix-release-3.2-1.el7.noarch.rpm

yum install -y zabbix-server-mysql zabbix-web-mysql

# CREATE DATABASE `zabbix` /*!40100 COLLATE 'utf8_general_ci' */

zcat /usr/share/doc/zabbix-server-mysql-3.2.1/create.sql.gz | mysql -uzabbix -p zabbix

cp /etc/zabbix/zabbix_server.conf{,.original}
vim /etc/zabbix/zabbix_server.conf <<EOF > /dev/null 2>&1
:%s/# DBPassword=/DBPassword=your_password/
:wq
EOF

systemctl enable httpd
systemctl enable zabbix-server

systemctl start zabbix-server
systemctl restart httpd
			]]>
			</screen>
			<para>配置php.ini文件 date.timezone = Asia/Hong_Kong</para>
			<para><graphic  format="png" fileref="../images/zabbix/zabbix-1.png" srccredit="neo" width=""/> 下一步</para>	
			<para><graphic  format="png" fileref="../images/zabbix/zabbix-2.png" srccredit="neo" width=""/> 检查PHP模块与配置，如果未提示错误信息点击下一步按钮</para>
			<para><graphic  format="png" fileref="../images/zabbix/zabbix-3.png" srccredit="neo" width=""/> 填写数据主机名，用户与密码，然后下一步</para>
			<para><graphic  format="png" fileref="../images/zabbix/zabbix-4.png" srccredit="neo" width=""/> Zabbix Server 直接点击下一步</para>
			<para><graphic  format="png" fileref="../images/zabbix/zabbix-5.png" srccredit="neo" width=""/> 确认填写信息，如果不正确可以返回重新填写，确认安装点击下一步</para>
			<para><graphic  format="png" fileref="../images/zabbix/zabbix-6.png" srccredit="neo" width=""/> 完成安装</para>
			<para><graphic  format="png" fileref="../images/zabbix/login.png" srccredit="neo" width=""/> 登陆Zabbix 默认用户名admin 密码 zabbix ，请务必登陆后修改密码</para>
		</section>
		
	</section>
	<section id="webui">
		<title>web ui</title>
		<para>http://localhost/zabbix/</para>
		<para>user: admin</para>
		<para>passwd: zabbix</para>
	</section>
	<section id="zabbix-java-gateway">
		<title>zabbix-java-gateway - Zabbix java gateway</title>
		<screen>
yum install -y zabbix-java-gateway
		</screen>
		<para>zabbix-java-gateway 包所含内容如下</para>
		<screen>
# rpm -ql zabbix-java-gateway
/etc/zabbix/zabbix_java_gateway.conf
/usr/lib/systemd/system/zabbix-java-gateway.service
/usr/sbin/zabbix_java_gateway
/usr/share/zabbix-java-gateway
/usr/share/zabbix-java-gateway/bin
/usr/share/zabbix-java-gateway/bin/zabbix-java-gateway-2.4.4.jar
/usr/share/zabbix-java-gateway/lib
/usr/share/zabbix-java-gateway/lib/android-json-4.3_r3.1.jar
/usr/share/zabbix-java-gateway/lib/logback-classic-0.9.27.jar
/usr/share/zabbix-java-gateway/lib/logback-console.xml
/usr/share/zabbix-java-gateway/lib/logback-core-0.9.27.jar
/usr/share/zabbix-java-gateway/lib/logback.xml
/usr/share/zabbix-java-gateway/lib/slf4j-api-1.6.1.jar		
		</screen>
		<para>配置/etc/zabbix/zabbix_server.conf文件</para>
		<screen>
# vim /etc/zabbix/zabbix_server.conf
### Option: JavaGateway
#       IP address (or hostname) of Zabbix Java gateway.
#       Only required if Java pollers are started.
#
# Mandatory: no
# Default:
JavaGateway=127.0.0.1

### Option: JavaGatewayPort
#       Port that Zabbix Java gateway listens on.
#
# Mandatory: no
# Range: 1024-32767
# Default:
JavaGatewayPort=10052

### Option: StartJavaPollers
#       Number of pre-forked instances of Java pollers.
#
# Mandatory: no
# Range: 0-1000
# Default:
StartJavaPollers=5		
		</screen>
		<para>配置 /etc/zabbix/zabbix_java_gateway.conf 文件</para>
		<screen>
# vim /etc/zabbix/zabbix_java_gateway.conf
# This is a configuration file for Zabbix Java Gateway.
# It is sourced by startup.sh and shutdown.sh scripts.

### Option: zabbix.listenIP
#	IP address to listen on.
#
# Mandatory: no
# Default:
LISTEN_IP="0.0.0.0"

### Option: zabbix.listenPort
#	Port to listen on.
#
# Mandatory: no
# Range: 1024-32767
# Default:
LISTEN_PORT=10052

### Option: zabbix.pidFile
#	Name of PID file.
#	If omitted, Zabbix Java Gateway is started as a console application.
#
# Mandatory: no
# Default:
# PID_FILE=

PID_FILE="/var/run/zabbix/zabbix_java.pid"

### Option: zabbix.startPollers
#	Number of worker threads to start.
#
# Mandatory: no
# Range: 1-1000
# Default:
START_POLLERS=5
		</screen>
		<para>启动 zabbix-java-gateway</para>
		<screen>
# systemctl enable zabbix-java-gateway.service
ln -s '/usr/lib/systemd/system/zabbix-java-gateway.service' '/etc/systemd/system/multi-user.target.wants/zabbix-java-gateway.service'

# systemctl start zabbix-java-gateway.service

systemctl restart zabbix-server

		</screen>
	</section>
	<section id="zabbix-agent">
		<title>zabbix-agent</title>
		<section>
			<title>Ubuntu</title>
			<screen>
# sudo apt-get install zabbix-agent
			</screen>
			<para>/etc/zabbix/zabbix_agent.conf</para>
			<screen>
#Server=localhost
Server=your_server_ip_address
			</screen>
			<para></para>
			<screen>
# vim /etc/services

zabbix-agent    10050/tcp                       #Zabbix Agent
zabbix-agent    10050/udp                       #Zabbix Agent
			</screen>
			<para></para>
			<screen>
# sudo /etc/init.d/zabbix-agent restart
			</screen>
		</section>
		<section>
			<title>CentOS 7</title>
			<screen>
yum localinstall -y http://repo.zabbix.com/zabbix/3.2/rhel/7/x86_64/zabbix-release-3.2-1.el7.noarch.rpm

yum install -y zabbix-agent

cp /etc/zabbix/zabbix_agentd.conf{,.original}

sed -i "s/# SourceIP=/SourceIP=zabbix_server_ip/" /etc/zabbix/zabbix_agentd.conf
sed -i "s/Server=127.0.0.1/Server=zabbix_server_ip/" /etc/zabbix/zabbix_agentd.conf
sed -i "s/ServerActive=127.0.0.1/ServerActive=zabbix_server_ip/" /etc/zabbix/zabbix_agentd.conf
sed -i "s/Hostname=Zabbix server/Hostname=Alpha Testing/" /etc/zabbix/zabbix_agentd.conf

systemctl enable zabbix-agent.service
systemctl start zabbix-agent.service

iptable -A INPUT -s zabbix_server_ip -p tcp -m state --state NEW -m tcp --dport 10050 -j ACCEPT
			</screen>
			<example>
				<title>zabbix-agent 配置实例</title>
				<screen>
# grep -v "^#" /etc/zabbix/zabbix_agentd.conf | grep -v "^$"
PidFile=/var/run/zabbix/zabbix_agentd.pid
LogFile=/var/log/zabbix/zabbix_agentd.log
LogFileSize=0
SourceIP=147.90.4.87
Server=147.90.4.87
ServerActive=147.90.4.87
Hostname=Alpha Testing
Include=/etc/zabbix/zabbix_agentd.d/*.conf			
				</screen>
			</example>
			<para>配置完成</para>
		</section>
		<section>
			<title>Nginx status 监控</title>
			<para>nginx status 监控扩展包 <ulink url="https://github.com/oscm/zabbix/tree/master/nginx" /></para>
			<para>从 localhost 收集 nginx 状态信息</para>
			<screen>
			<![CDATA[
server {
    listen       80;
    server_name  localhost;

    location /status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        deny all;
    }
}
			]]>
			</screen>
			<para>配置 zabbix_agentd</para>
			<para>创建配置文件 /etc/zabbix/zabbix_agentd.d/userparameter_nginx.conf 内容如下：</para>
			<screen>
			<![CDATA[
UserParameter=nginx.status[*],/srv/zabbix/libexec/nginx.sh $1
			]]>
			</screen>
			<para>安装数据采集脚本，请使用 nginx.sh </para>
			<screen>
			<![CDATA[
mkdir -p /srv/zabbix/libexec
vim /srv/zabbix/libexec/nginx.sh

chmod +x /srv/zabbix/libexec/nginx.sh

# /srv/zabbix/libexec/nginx.sh
Usage /srv/zabbix/libexec/nginx.sh {check|active|accepts|handled|requests|reading|writing|waiting}
# /srv/zabbix/libexec/nginx.sh accepts
82

# systemctl restart zabbix-agent.service
			]]>
			</screen>
			<para>使用 zabbix-get 工具从 Zabbix Server 链接 Zabbix Agent 测试是否正常工作</para>
			<screen>
			<![CDATA[
Test Agent

# yum install -y zabbix-get

# zabbix_get -s <agent_ip_address> -k 'nginx.status[accepts]'
109
			]]>
			</screen>
			<para>最后进入Zabbix Web界面导入模板 zbx_export_templates.xml</para>
			<screen>
			<![CDATA[
Import file: choice xml file
click "import" button

Imported successfully 表示成功导入
			]]>
			</screen>
		</section>
	</section>
</chapter>