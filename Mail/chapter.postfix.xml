<?xml version="1.0" encoding="UTF-8"?>
<!-- $Id: chapter.mail.postfix.xml 457 2012-08-24 11:38:17Z netkiller $ -->
<!-- 
<part id="mail.server.postfix">
	<title>Postfix</title>
</part>
 -->
<chapter id="index"><?dbhtml dir="postfix" ?>
	<title>postfix - High-performance mail transport agent</title>
	<para><ulink url="http://www.postfix.org/">Postfix 主页</ulink></para>
	<section id="install">
		<title>install</title>
		<section id="ubuntu">
			<title>Ubuntu</title>
			<screen>
$ sudo apt-get install postfix
			</screen>
			<para>configure</para>
			<screen>
$ sudo dpkg-reconfigure postfix-config
			</screen>
		</section>
		<section id="centos">
			<title>CentOS</title>
			<screen>
# yum install -y postfix			
			</screen>
			<screen>
myhostname = mail.example.com
mydomain = example.com
myorigin = $mydomain
inet_interfaces = all
mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain
#mynetworks = 192.168.0.0/24, 127.0.0.0/8
#relay_domains =
home_mailbox = Maildir/
			</screen>
		</section>
		<section>
			<title>OSCM 通过配置管理脚本安装</title>
			<screen>
Postfix Install

# Centos Init
curl -s https://raw.githubusercontent.com/oscm/shell/master/os/centos7.sh | bash
curl -s https://raw.githubusercontent.com/oscm/shell/master/os/selinux.sh | bash
curl -s https://raw.githubusercontent.com/oscm/shell/master/os/iptables/iptables.sh | bash
curl -s https://raw.githubusercontent.com/oscm/shell/master/os/ntpd/ntp.sh | bash
curl -s https://raw.githubusercontent.com/oscm/shell/master/os/ssh/sshd_config.sh | bash

# Install Postfix
curl -s https://raw.githubusercontent.com/oscm/shell/master/mail/postfix/postfix.sh | bash
			</screen>
		</section>
	</section>
 	
	<section id="transport_maps">
		<title>转发配置</title>
		<para>修改配置文件</para>
		<screen>
vim /etc/postfix/main.cf

inet_interfaces = all

mydestination = 

mydomain = example.com

myhostname = mail.example.com

mynetworks = 0.0.0.0/0

mynetworks_style = subnet

smtpd_reject_unlisted_recipient = no

transport_maps = hash:/etc/postfix/transport
		</screen>
		<para>转发配置，设置域名和地址的关系：</para>
		<screen>
vim transport：

your.com relay: [10.10.0.1]		
		</screen>
		<para>生成相应的db文件</para>
		<screen>
postmap transport		
		</screen>
		<para>例如当收件人为users@your.com时，postfix会将邮件转发到指定的服务器</para>
	</section>
	<section id="smtpd_recipient_restrictions">
		<title>拒收垃圾邮件</title>
		
		<para>编辑/etc/postfix/main.cf文件,在文件中添加下面一行文字，你可以把它插入到文件末尾。</para>
		<screen>
sudo vim /etc/postfix/main.cf

smtpd_recipient_restrictions = check_sender_access hash:/etc/postfix/check_sender_access		
		</screen>
		<para>然后在/etc/postfix/目录下创建一个check_sender_access文件，内容如下</para>
		<screen>
example.com            REJECT
your.com              OK

.example.com            REJECT
.your.com              OK

user@example.com      REJECT
		</screen>
		<para>将域名的特定邮箱地址添加到黑名单,也可以将某个二级域名添加到黑名单或白名单，只要在域名前面加上一个小数点就行了。邮箱与域名后面输入OK表示将这个域名添加到白名单，域名后面添加REJECT表示将这个域名添加到黑名单。</para>
		<para>使用postmap命令创建/etc/postfix/sender_checks.db数据库文件</para>
		<screen>
postmap /etc/postfix/check_sender_access
		</screen>
		<para>最后重新加载Postfix配置文件</para> 
		<screen>
sudo /etc/init.d/postfix reload		
		</screen>
	</section>
	<section id="rspamd">
		<title>Rspamd</title>
		<para>Rspamd是一个反垃圾邮件系统，因为使用事件模型和正则表达式优化，其设计工作速度比SpamAssassin还 要快。目前推出的功能： regexp规则过滤的不同部分的信息;一些内置的功能分析的信息;模糊哈希支持; SURBL滤波器;电子邮件和性质表支持;控制界面进行远程管理和统计信息收集，一个Perl和卢阿插件系统;统计支持（定向结构刨花板/簸扬） ;兼容SpamAssassin ;和一个客户端程序的电子邮件扫描。类似的规则， rspamd约10倍SpamAssassin 。</para>
	</section>
	<section id="maillog">
		<title>/var/log/maillog</title>
		<para>邮件正常发送时的日志</para>
		<screen>
		<![CDATA[
# grep '7905611F797'  maillog
Nov  2 16:07:58 smtp2.example.com postfix/pickup[7377]: 7905611F797: uid=0 from=<root>
Nov  2 16:07:58 smtp2.example.com postfix/cleanup[7683]: 7905611F797: message-id=<20151102080758.GA7677@smtp2.example.com>
Nov  2 16:07:58 smtp2.example.com postfix/qmgr[21697]: 7905611F797: from=<root@mail2.example.com>, size=461, nrcpt=1 (queue active)
Nov  2 16:08:08 smtp2.example.com postfix/smtp[7674]: 7905611F797: to=<skyline.chen@icloud.com>, relay=mx3.mail.icloud.com[17.172.34.64]:25, delay=10, delays=0.04/0/6.2/4.1, dsn=2.5.0, status=sent (250 2.5.0 Ok.)
Nov  2 16:08:08 smtp2.example.com postfix/qmgr[21697]: 7905611F797: removed
		]]>
		</screen>
		<para>被封IP地址</para>
		<screen>
		<![CDATA[		
Nov  2 15:25:57 smtp2.example.com postfix/cleanup[6993]: C17AC11F78C: message-id=<20151102072557.C17AC11F78C@mail2.example.com>
Nov  2 15:25:57 smtp2.example.com postfix/bounce[6992]: 0E6FE11F777: sender non-delivery notification: C17AC11F78C
Nov  2 15:25:57 smtp2.example.com postfix/qmgr[21697]: C17AC11F78C: from=<>, size=17147, nrcpt=1 (queue active)
Nov  2 15:25:58 smtp2.example.com postfix/smtp[6928]: C17AC11F78C: to=<cs@example.com>, relay=mx.qiye.163.com[123.125.50.217]:25, delay=0.96, delays=0/0/0.53/0.42, dsn=5.0.0, status=bounced (host mx.qiye.163.com[123.125.50.217] said: 554 DT:SPM mx6, Q9OowEC5hUgGEDdWRyf1AQ--.1S2 1446449158 http://mail.163.com/help/help_spam_16.htm?ip=202.82.201.90&hostid=mx6&time=1446449158 (in reply to end of DATA command))
Nov  2 15:25:58 smtp2.example.com postfix/qmgr[21697]: C17AC11F78C: removed
		]]>
		</screen>
		<para>发送密度过高</para>
		<screen>
		<![CDATA[
Nov  2 15:24:25 smtp2.example.com postfix/smtpd[6940]: 6D21E11F76A: client=unknown[172.18.52.137]
Nov  2 15:24:25 smtp2.example.com postfix/cleanup[6945]: 6D21E11F76A: message-id=<17f164cf2441ad60eb2ce794db4959bf@localhost.localdomain>
Nov  2 15:24:25 smtp2.example.com postfix/qmgr[21697]: 6D21E11F76A: from=<cs@example.com>, size=15050, nrcpt=1 (queue active)
Nov  2 15:24:25 smtp2.example.com postfix/smtp[6922]: 6D21E11F76A: lost connection with mx3.QQ.com[103.7.30.40] while performing the HELO handshake
Nov  2 15:24:30 smtp2.example.com postfix/smtp[6922]: 6D21E11F76A: to=<1141096962@qq.com>, relay=mx2.QQ.com[184.105.206.86]:25, delay=5.2, delays=0.01/0/4.9/0.35, dsn=5.0.0, status=bounced (host mx2.QQ.com[184.105.206.86] said: 550 Connection frequency limited. http://service.mail.qq.com/cgi-bin/help?subtype=1&&id=20022&&no=1000722 (in reply to MAIL FROM command))
Nov  2 15:24:30 smtp2.example.com postfix/bounce[6946]: 6D21E11F76A: sender non-delivery notification: A76A511F777
Nov  2 15:24:30 smtp2.example.com postfix/qmgr[21697]: 6D21E11F76A: removed
		]]>
		</screen>
		<para>虚假地址，产生 Connection timed out</para>
		<screen>
		<![CDATA[
Nov  2 16:32:21 smtp2.example.com postfix/smtp[7732]: 1DCD811F940: to=<1608014274@qqq.com>, relay=none, delay=368099, delays=368069/0.05/30/0, dsn=4.4.1, status=deferred (connect to qqq.com[60.190.249.48]:25: Connection timed out)		
		]]>
		</screen>
		<section>
			<title>计算每分钟发送数量日志统计</title>
			<para>计算每分钟发送数量</para>
			<screen>
# grep 'to='  maillog | grep '15:25:' | wc -l
592
			</screen>
		</section>
		
		<section>
			<title>虚假地址统计</title>
			<para>计算每分钟发送数量</para>
			<screen>
			<![CDATA[
# egrep -o "to=<(.*)>, .* Connection timed out" maillog | sed -e "s/to=<\(.*\)>.*/\1/"
			]]>
			</screen>
		</section>
		
	</section>
	
	<section id="postmulti">
		<title>postmulti - Postfix multi-instance manager</title>
		<section>
			<title>绑定IP地址</title>
			<para>将所有IP地址绑定到服务器上</para>
			<screen>
cd /etc/sysconfig/network-scripts

vim ifcfg-enp2s0
			</screen>
			<screen>
# cat ifcfg-enp2s0  
TYPE="Ethernet"
BOOTPROTO="none"
DEFROUTE="yes"
IPV4_FAILURE_FATAL="no"
IPV6INIT="yes"
IPV6_AUTOCONF="yes"
IPV6_DEFROUTE="yes"
IPV6_FAILURE_FATAL="no"
NAME="enp2s0"
UUID="c27c6ef8-ab82-4019-af0a-9f3a70b2d230"
DEVICE="enp2s0"
ONBOOT="yes"
DNS1="8.8.8.8"
IPADDR="192.168.0.1"
...
...
IPADDR247="192.168.0.250"
PREFIX="26"
PERFIX0="24"
GATEWAY="192.168.0.254"
IPV6_PEERDNS="yes"
IPV6_PEERROUTES="yes"
IPV6_PRIVACY="no"
			</screen>
			<para>IP范围 192.168.0.1-192.168.0.250，接口是enp2s0，enp2s0:1 ~ enp2s0:250 </para>
		</section>
		<section>
			<title>postfix 多实例配置</title>
			<para>初始化postfix 多实例</para>
			<screen>
postmulti -e init			
			</screen>
			<para>创建postfix实例</para>
			<screen>
postmulti -I postfix-1 -G mta -e create
...
...
postmulti -I postfix-250 -G mta -e create			
			</screen>
			<para>启用postfix 实例</para>
			<screen>
postmulti -i postfix-1 -e enable
...
...
postmulti -i postfix-250 -e enable
			</screen>
			<para>配置postfix实例</para>
			<screen>
postmulti -i postfix-1 -x postconf -e "master_service_disable =" "authorized_submit_users = root" "minimal_backoff_time= 30d" "maximal_backoff_time = 300d" "mynetworks = 127.0.0.0/8,192.168.0.0/24" "inet_interfaces = \$myhostname" "mailbox_size_limit = 0" "message_size_limit = 0" "myhostname =  mail.example.com" "myorigin =  mail.example.com" "mydomain =  example.com" "smtp_bind_address =  192.168.0.1"
...
...
postmulti -i postfix-250 -x postconf -e "master_service_disable =" "authorized_submit_users = root" "minimal_backoff_time= 30d" "maximal_backoff_time = 300d" "mynetworks = 127.0.0.0/8,192.168.0.0/24" "inet_interfaces = \$myhostname" "mailbox_size_limit = 0" "message_size_limit = 0" "myhostname =  mail.example.com" "myorigin =  mail.example.com" "mydomain =  example.com" "smtp_bind_address =  192.168.0.250"
			</screen>
		</section>
		<section>
			<title>配置 iptables 让SMTPD发送邮件时依次轮询外发IP地址，这样就不会被封锁。</title>
			<screen>
iptables -t nat -I POSTROUTING -m state --state NEW -p tcp --dport 25 -o eth0 -m statistic --mode nth --every 250 -j SNAT --to-source 192.168.0.1
...
...
iptables -t nat -I POSTROUTING -m state --state NEW -p tcp --dport 25 -o eth0 -m statistic --mode nth --every 250 -j SNAT --to-source 192.168.0.250
			</screen>
			<para>注意，不要使用下面的方式配置iptables，经过测试这种192.168.0.1-192.168.0.250方式，不会轮换IP地址。</para>
			<screen>
iptables -t nat -I POSTROUTING -o enp2s0f0 -p tcp -m state --state NEW -m tcp -m statistic --mode nth --every 5 --packet 0 -j SNAT --to-source 192.168.0.1-192.168.0.250
			</screen>
		</section>
	</section>
	
	<section id="faq">
		<title>FAQ</title>
		<section>
			<title>SMTP ERROR: RCPT TO command failed: 501 5.1.3 Bad recipient address syntax</title>
			<para>客户端反馈</para>
			<screen>
			<![CDATA[
SMTP ERROR: RCPT TO command failed: 501 5.1.3 Bad recipient address syntax
2015-09-23 08:06:12	SMTP Error: The following recipients failed: root@example.com: Bad recipient address syntax
<strong>SMTP Error: The following recipients failed: root@example.com: Bad recipient address syntax			
			]]>
			</screen>
			<para>/var/log/maillog</para>
			<screen>
			<![CDATA[
Sep 23 16:12:00 smtp1 postfix/smtpd[982]: NOQUEUE: reject: RCPT from unknown[202.130.101.34]: 554 5.7.1 <netkiller@msn.com>: Relay access denied; from=<root@mail.example.com> to=<netkiller@msn.com> proto=ESMTP helo=<localhost.localdomain>
			]]>			
			</screen>
			<para>问题原因是 mynetworks 配置项没有放行客户端</para>
			<screen>
[root@netkiller.github.io ~]# postconf | grep permit_mynetworks
smtpd_recipient_restrictions = permit_mynetworks, reject_unauth_destination			
			</screen>
			<para>设置mynetworks配置项，允许IP使用SMTP发送邮件</para>
			<screen>
[root@netkiller.github.io ~]# postconf -n | grep mynetworks
mynetworks = 202.130.101.34
			</screen>
		</section>
	</section>
</chapter>
